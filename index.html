<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- 기존 코드 그대로 유지 -->
  <!-- CSS 부분에 추가 -->
  <style>
    /* 기존 스타일 그대로 유지하고 아래 스타일 추가 */
    
    /* 바구니 드래그 가능 스타일 */
    .draggable {
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    
    .draggable:active {
      cursor: grabbing;
    }
    
    /* 게임 컨트롤 버튼 숨김 */
    .controls-hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- 기존 HTML 코드는 그대로 유지하되 아래 부분만 수정 -->
  
  <!-- 사과 게임 화면에서 컨트롤 버튼 제거 -->
  <div id="appleGameTab" class="tab-content p-4 hidden">
    <div class="text-lg font-bold mb-3 text-center">사과 게임</div>
    <div class="bg-red-50 p-4 rounded-lg shadow">
      <div class="text-center text-sm mb-3">
        사과를 받고 벌레는 피하세요! 최대 50골드!
      </div>
      
      <div class="relative h-60 bg-blue-50 rounded-lg mb-4 overflow-hidden border-2 border-blue-100">
        <div id="appleGameArea" class="absolute inset-0">
          <!-- 게임 요소들이 여기에 추가됩니다 -->
          <div id="gameBasket" class="absolute bottom-0 text-3xl draggable" style="left: 45%;">🧺</div>
        </div>
        
        <!-- 게임 컨트롤 버튼 제거 -->
        <!-- <div id="gameControlsOverlay" class="absolute inset-x-0 bottom-0 h-12 flex justify-between items-center z-10 px-4 controls-hidden">
          <button id="moveLeftBtn" class="bg-blue-500 bg-opacity-70 text-white h-10 w-10 rounded-full flex items-center justify-center text-xl">
            ←
          </button>
          <button id="moveRightBtn" class="bg-blue-500 bg-opacity-70 text-white h-10 w-10 rounded-full flex items-center justify-center text-xl">
            →
          </button>
        </div> -->
        
        <div id="gameTimer" class="absolute top-2 right-2 bg-white bg-opacity-70 text-xs font-bold px-2 py-1 rounded-full">
          30초
        </div>
        
        <div id="gameOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
          <div class="bg-white p-4 rounded-lg text-center">
            <div class="text-xl font-bold mb-2">준비 완료!</div>
            <div class="text-sm mb-3">화면을 슬라이드해서 바구니를 움직이세요</div>
            <button id="startGameBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold">
              게임 시작!
            </button>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-3 gap-2 mb-4">
        <div class="bg-white p-2 rounded-lg shadow text-center">
          <div class="text-xs text-gray-500">사과 점수</div>
          <div class="font-bold text-base text-red-500"><span id="appleScore">0</span>개</div>
        </div>
        <div class="bg-white p-2 rounded-lg shadow text-center">
          <div class="text-xs text-gray-500">벌레 감점</div>
          <div class="font-bold text-base text-green-700">-<span id="bugPenalty">0</span>개</div>
        </div>
        <div class="bg-white p-2 rounded-lg shadow text-center">
          <div class="text-xs text-gray-500">골드</div>
          <div class="font-bold text-base text-yellow-500"><span id="appleGold">0</span>골드</div>
        </div>
      </div>
      
      <div id="appleGameResult" class="hidden">
        <div class="bg-green-100 text-green-600 text-center p-3 rounded-lg mb-3 text-sm font-bold">
          게임 종료! <span id="finalAppleGold">0</span>골드 획득!
        </div>
      </div>
      
      <div class="flex justify-between">
        <button id="appleBackBtn" class="bg-gray-500 text-white font-bold px-4 py-2 rounded-lg">
          그만두기
        </button>
        <button id="appleCashOutBtn" class="bg-green-500 text-white font-bold px-4 py-2 rounded-lg hidden">
          현재 골드 받기
        </button>
        <button id="applePlayAgainBtn" class="bg-blue-500 text-white font-bold px-4 py-2 rounded-lg hidden">
          다시하기 (광고)
        </button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 기존 코드 유지
      
      // 사과 게임 관련 코드 수정
      let appleScore = 0;
      let bugPenalty = 0;
      let appleGold = 0;
      let appleGameActive = false;
      let gameInterval;
      let gameTimeLeft = 30;
      let basketPosition = 45; // 바구니 위치 (%)
      const basketWidth = 10; // 바구니 너비 (%)
      const basketElement = document.getElementById('gameBasket');
      const gameArea = document.getElementById('appleGameArea');
      const gameWidth = 100; // 게임 영역 너비 (%)
      
      // 기존 사과 게임 초기화 함수 - 그대로 유지
      function initAppleGame() {
        // 게임 초기화
        appleScore = 0;
        bugPenalty = 0;
        appleGold = 0;
        appleGameActive = false;
        gameTimeLeft = 30;
        basketPosition = 45;
        basketElement.style.left = `${basketPosition}%`;
        
        // UI 초기화
        document.getElementById('appleScore').textContent = appleScore;
        document.getElementById('bugPenalty').textContent = bugPenalty;
        document.getElementById('appleGold').textContent = appleGold;
        document.getElementById('gameTimer').textContent = `${gameTimeLeft}초`;
        document.getElementById('appleGameResult').classList.add('hidden');
        
        // 게임 요소 초기화
        const items = document.querySelectorAll('.falling-item');
        items.forEach(item => item.remove());
        
        // 버튼 상태 초기화
        document.getElementById('appleCashOutBtn').classList.add('hidden');
        document.getElementById('applePlayAgainBtn').classList.add('hidden');
        
        // 게임 준비 오버레이 표시
        document.getElementById('gameOverlay').classList.remove('hidden');
      }
      
      // 게임 시작 버튼
      document.getElementById('startGameBtn').addEventListener('click', function() {
        // 게임 준비 오버레이 숨기기
        document.getElementById('gameOverlay').classList.add('hidden');
        
        // 게임 활성화
        appleGameActive = true;
        
        // 타이머 시작
        startGameTimer();
        
        // 아이템 생성 시작
        gameInterval = setInterval(generateFallingItem, 800); // 0.8초마다 아이템 생성
      });
      
      // 기존 함수들 - 그대로 유지
      function startGameTimer() {
        const timerInterval = setInterval(() => {
          gameTimeLeft--;
          document.getElementById('gameTimer').textContent = `${gameTimeLeft}초`;
          
          // 시간이 다 되면 게임 종료
          if (gameTimeLeft <= 0) {
            clearInterval(timerInterval);
            clearInterval(gameInterval);
            endGame();
          }
        }, 1000);
      }
      
      function endGame() {
        appleGameActive = false;
        
        // 골드 계산 (사과 1개당 3골드, 벌레 1개당 -2골드)
        const totalScore = Math.max(0, appleScore - bugPenalty);
        appleGold = totalScore * 3;
        
        // 상금 한도 설정
        appleGold = Math.min(appleGold, 50);
        
        // UI 업데이트
        document.getElementById('appleGold').textContent = appleGold;
        document.getElementById('appleGameResult').classList.remove('hidden');
        document.getElementById('finalAppleGold').textContent = appleGold;
        
        // 골드 증가
        const gold = document.getElementById('gold');
        gold.textContent = parseInt(gold.textContent) + appleGold;
        
        // 알림 표시
        showToast(`${appleGold} 골드가 지급되었습니다!`, 'success');
        
        // 다시하기 버튼 표시
        document.getElementById('applePlayAgainBtn').classList.remove('hidden');
      }
      
      function generateFallingItem() {
        if (!appleGameActive) return;
        
        const gameArea = document.getElementById('appleGameArea');
        const item = document.createElement('div');
        
        // 80% 확률로 사과, 20% 확률로 벌레
        const isApple = Math.random() < 0.8;
        item.textContent = isApple ? '🍎' : '🐛';
        item.className = 'falling-item text-2xl';
        item.dataset.type = isApple ? 'apple' : 'bug';
        
        // 랜덤 위치 (좌우)
        const left = Math.floor(Math.random() * 85) + 5; // 5% ~ 90%
        item.style.left = `${left}%`;
        
        // 랜덤 속도 (아래로 떨어지는 시간)
        const fallSpeed = Math.random() * 1 + 1.5; // 1.5초 ~ 2.5초
        item.style.animationDuration = `${fallSpeed}s`;
        
        gameArea.appendChild(item);
        
        // 아이템이 바닥에 닿았을 때 검사
        item.addEventListener('animationend', () => {
          // 바구니 위치와 아이템 위치 비교
          const itemLeft = parseFloat(item.style.left);
          
          // 충돌 감지 (바구니와 아이템이 겹치는지)
          if (itemLeft >= basketPosition - basketWidth/2 && itemLeft <= basketPosition + basketWidth/2) {
            // 바구니에 들어옴
            if (item.dataset.type === 'apple') {
              // 사과 획득
              appleScore++;
              document.getElementById('appleScore').textContent = appleScore;
              
              // 점수 증가 애니메이션
              const scoreElement = document.getElementById('appleScore');
              scoreElement.classList.add('score-pop');
              setTimeout(() => {
                scoreElement.classList.remove('score-pop');
              }, 500);
            } else {
              // 벌레 감점
              bugPenalty++;
              document.getElementById('bugPenalty').textContent = bugPenalty;
              
              // 감점 애니메이션
              const penaltyElement = document.getElementById('bugPenalty');
              penaltyElement.classList.add('penalty-shake');
              setTimeout(() => {
                penaltyElement.classList.remove('penalty-shake');
              }, 300);
              
              // 바구니 흔들림 애니메이션
              basketElement.classList.add('shake');
              setTimeout(() => {
                basketElement.classList.remove('shake');
              }, 300);
            }
          }
          
          // 아이템 제거
          item.remove();
        });
      }
      
      // 이동 버튼 이벤트 리스너 제거하고 새로운 드래그 이벤트 리스너 추가
      
      // 바구니 드래그 기능 구현
      let isDragging = false;
      let lastTouchX = 0;
      let lastMouseX = 0;
      const gameAreaBounds = gameArea.getBoundingClientRect();
      
      // 터치 이벤트 (모바일)
      basketElement.addEventListener('touchstart', function(e) {
        if (!appleGameActive) return;
        isDragging = true;
        lastTouchX = e.touches[0].clientX;
        basketElement.classList.add('grabbing');
        e.preventDefault(); // 기본 동작 방지
      });
      
      document.addEventListener('touchmove', function(e) {
        if (!isDragging || !appleGameActive) return;
        
        const gameAreaBounds = gameArea.getBoundingClientRect();
        const touch = e.touches[0];
        const deltaX = touch.clientX - lastTouchX;
        lastTouchX = touch.clientX;
        
        // 이동 거리를 게임 영역 너비의 퍼센트로 변환
        const deltaPercent = (deltaX / gameAreaBounds.width) * 100;
        
        // 바구니 위치 업데이트
        basketPosition = Math.max(0, Math.min(90, basketPosition + deltaPercent));
        basketElement.style.left = `${basketPosition}%`;
        
        e.preventDefault(); // 기본 동작 방지
      });
      
      document.addEventListener('touchend', function() {
        isDragging = false;
        basketElement.classList.remove('grabbing');
      });
      
      document.addEventListener('touchcancel', function() {
        isDragging = false;
        basketElement.classList.remove('grabbing');
      });
      
      // 마우스 이벤트 (PC)
      basketElement.addEventListener('mousedown', function(e) {
        if (!appleGameActive) return;
        isDragging = true;
        lastMouseX = e.clientX;
        basketElement.classList.add('grabbing');
        e.preventDefault(); // 기본 동작 방지
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isDragging || !appleGameActive) return;
        
        const gameAreaBounds = gameArea.getBoundingClientRect();
        const deltaX = e.clientX - lastMouseX;
        lastMouseX = e.clientX;
        
        // 이동 거리를 게임 영역 너비의 퍼센트로 변환
        const deltaPercent = (deltaX / gameAreaBounds.width) * 100;
        
        // 바구니 위치 업데이트
        basketPosition = Math.max(0, Math.min(90, basketPosition + deltaPercent));
        basketElement.style.left = `${basketPosition}%`;
      });
      
      document.addEventListener('mouseup', function() {
        isDragging = false;
        basketElement.classList.remove('grabbing');
      });
      
      document.addEventListener('mouseleave', function() {
        isDragging = false;
        basketElement.classList.remove('grabbing');
      });
      
      // 기존 사과 게임 뒤로가기/다시하기 버튼 이벤트 리스너 유지
      document.getElementById('appleBackBtn').addEventListener('click', () => {
        // 게임 중이라면 종료
        if (appleGameActive) {
          clearInterval(gameInterval);
        }
        
        switchTab('homeTab');
      });
      
      document.getElementById('applePlayAgainBtn').addEventListener('click', () => {
        // 광고 시청 후 다시하기
        watchAd(() => {
          initAppleGame();
        });
      });
    });
  </script>
</body>
</html>
