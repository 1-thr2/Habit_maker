<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- 기존 헤더 부분은 그대로 유지합니다 -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>목표 달성 or Die</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* 기존 스타일 유지 */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
    
    /* 기존 스타일 코드는 동일하게 유지합니다 */
    /* CSS 생략 (기존 CSS 유지) */
    
    /* 드래그 가능한 바구니를 위한 추가 스타일 */
    .draggable-basket {
      cursor: grab;
      touch-action: none; /* 터치 이벤트 핸들링을 위해 브라우저 기본 터치 동작 비활성화 */
      user-select: none; /* 텍스트 선택 방지 */
      -webkit-user-select: none;
      position: absolute;
      bottom: 0;
      z-index: 10;
    }
    
    .draggable-basket:active {
      cursor: grabbing;
    }
    
    /* 게임 영역에 대한 스타일 수정 */
    .game-area-container {
      position: relative;
      touch-action: none; /* 전체 게임 영역도 기본 터치 동작 비활성화 */
      overflow: hidden;
    }
  </style>
</head>
<body>
  <!-- 기존 HTML 구조 유지 -->
  <!-- 여기서는 변경이 필요한 사과 게임 부분만 수정합니다 -->
  
  <!-- 사과 게임 화면 -->
  <div id="appleGameTab" class="tab-content p-4 hidden">
    <div class="text-lg font-bold mb-3 text-center">사과 게임</div>
    <div class="bg-red-50 p-4 rounded-lg shadow">
      <div class="text-center text-sm mb-3">
        사과를 받고 벌레는 피하세요! 최대 50골드!
      </div>
      
      <div class="relative h-60 bg-blue-50 rounded-lg mb-4 overflow-hidden border-2 border-blue-100 game-area-container">
        <div id="appleGameArea" class="absolute inset-0">
          <!-- 게임 요소들이 여기에 추가됩니다 -->
          <div id="gameBasket" class="absolute bottom-0 text-3xl draggable-basket" style="left: 45%;">🧺</div>
        </div>
        
        <!-- 좌우 이동 버튼 제거됨 -->
        
        <div id="gameTimer" class="absolute top-2 right-2 bg-white bg-opacity-70 text-xs font-bold px-2 py-1 rounded-full">
          30초
        </div>
        
        <div id="gameOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
          <div class="bg-white p-4 rounded-lg text-center">
            <div class="text-xl font-bold mb-2">준비 완료!</div>
            <div class="text-sm mb-3">사과를 받고 벌레는 피하세요</div>
            <div class="text-xs mb-3 text-gray-600">바구니를 좌우로 슬라이드하여 이동시키세요!</div>
            <button id="startGameBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold">
              게임 시작!
            </button>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-3 gap-2 mb-4">
        <div class="bg-white p-2 rounded-lg shadow text-center">
          <div class="text-xs text-gray-500">사과 점수</div>
          <div class="font-bold text-base text-red-500"><span id="appleScore">0</span>개</div>
        </div>
        <div class="bg-white p-2 rounded-lg shadow text-center">
          <div class="text-xs text-gray-500">벌레 감점</div>
          <div class="font-bold text-base text-green-700">-<span id="bugPenalty">0</span>개</div>
        </div>
        <div class="bg-white p-2 rounded-lg shadow text-center">
          <div class="text-xs text-gray-500">골드</div>
          <div class="font-bold text-base text-yellow-500"><span id="appleGold">0</span>골드</div>
        </div>
      </div>
      
      <div id="appleGameResult" class="hidden">
        <div class="bg-green-100 text-green-600 text-center p-3 rounded-lg mb-3 text-sm font-bold">
          게임 종료! <span id="finalAppleGold">0</span>골드 획득!
        </div>
      </div>
      
      <div class="flex justify-between">
        <button id="appleBackBtn" class="bg-gray-500 text-white font-bold px-4 py-2 rounded-lg">
          그만두기
        </button>
        <button id="appleCashOutBtn" class="bg-green-500 text-white font-bold px-4 py-2 rounded-lg hidden">
          현재 골드 받기
        </button>
        <button id="applePlayAgainBtn" class="bg-blue-500 text-white font-bold px-4 py-2 rounded-lg hidden">
          다시하기 (광고)
        </button>
      </div>
    </div>
  </div>
  
  <!-- 나머지 HTML 코드 유지 -->
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 기존 코드 유지 (탭 전환, 점수 계산 등)
      
      // 변경할 부분: 사과 게임 관련 코드
      let appleScore = 0;
      let bugPenalty = 0;
      let appleGold = 0;
      let appleGameActive = false;
      let gameInterval;
      let gameTimeLeft = 30;
      let basketPosition = 45; // 바구니 위치 (%)
      const basketWidth = 10; // 바구니 너비 (%)
      const basketElement = document.getElementById('gameBasket');
      const gameArea = document.getElementById('appleGameArea');
      const gameAreaContainer = gameArea.parentElement;
      const gameWidth = 100; // 게임 영역 너비 (%)
      
      // 바구니 드래그 관련 변수
      let isDragging = false;
      let startX = 0;
      let startLeft = 0;
      
      function initAppleGame() {
        // 게임 초기화 (기존 코드)
        appleScore = 0;
        bugPenalty = 0;
        appleGold = 0;
        appleGameActive = false;
        gameTimeLeft = 30;
        basketPosition = 45;
        basketElement.style.left = `${basketPosition}%`;
        
        // UI 초기화 (기존 코드)
        document.getElementById('appleScore').textContent = appleScore;
        document.getElementById('bugPenalty').textContent = bugPenalty;
        document.getElementById('appleGold').textContent = appleGold;
        document.getElementById('gameTimer').textContent = `${gameTimeLeft}초`;
        document.getElementById('appleGameResult').classList.add('hidden');
        
        // 게임 요소 초기화 (기존 코드)
        const items = document.querySelectorAll('.falling-item');
        items.forEach(item => item.remove());
        
        // 버튼 상태 초기화 (기존 코드)
        document.getElementById('appleCashOutBtn').classList.add('hidden');
        document.getElementById('applePlayAgainBtn').classList.add('hidden');
        
        // 게임 준비 오버레이 표시 (기존 코드)
        document.getElementById('gameOverlay').classList.remove('hidden');
      }
      
      // 드래그 이벤트 설정 (새로운 코드)
      function setupDraggableBasket() {
        // 마우스 이벤트
        basketElement.addEventListener('mousedown', startDrag);
        
        // 터치 이벤트
        basketElement.addEventListener('touchstart', startDrag, { passive: false });
        
        // 게임 영역 전체에서 드래그 가능하도록 이벤트 설정
        gameAreaContainer.addEventListener('mousemove', drag);
        gameAreaContainer.addEventListener('touchmove', drag, { passive: false });
        
        // 드래그 종료 이벤트
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
      }
      
      function startDrag(e) {
        e.preventDefault(); // 기본 동작 방지
        isDragging = true;
        
        // 마우스 또는 터치의 시작 위치 저장
        if (e.type === 'touchstart') {
          startX = e.touches[0].clientX;
        } else {
          startX = e.clientX;
        }
        
        // 현재 바구니 위치 저장
        startLeft = basketPosition;
        
        // 커서 스타일 변경
        basketElement.style.cursor = 'grabbing';
      }
      
      function drag(e) {
        if (!isDragging) return;
        e.preventDefault(); // 기본 동작 방지
        
        // 현재 마우스/터치 위치
        let currentX;
        if (e.type === 'touchmove') {
          currentX = e.touches[0].clientX;
        } else {
          currentX = e.clientX;
        }
        
        // 이동 거리 계산
        const deltaX = currentX - startX;
        
        // 게임 영역의 너비를 기준으로 % 단위 변환
        const gameAreaWidth = gameAreaContainer.clientWidth;
        const deltaPercent = (deltaX / gameAreaWidth) * 100;
        
        // 새로운 위치 계산 (경계 제한)
        let newPosition = startLeft + deltaPercent;
        newPosition = Math.max(5, Math.min(90, newPosition)); // 5% ~ 90% 범위로 제한
        
        // 바구니 위치 업데이트
        basketPosition = newPosition;
        basketElement.style.left = `${basketPosition}%`;
      }
      
      function endDrag() {
        isDragging = false;
        basketElement.style.cursor = 'grab';
      }
      
      // 기존 게임 관련 함수들
      function startGameTimer() {
        const timerInterval = setInterval(() => {
          gameTimeLeft--;
          document.getElementById('gameTimer').textContent = `${gameTimeLeft}초`;
          
          // 시간이 다 되면 게임 종료
          if (gameTimeLeft <= 0) {
            clearInterval(timerInterval);
            clearInterval(gameInterval);
            endGame();
          }
        }, 1000);
      }
      
      function endGame() {
        appleGameActive = false;
        
        // 골드 계산 (사과 1개당 3골드, 벌레 1개당 -2골드)
        const totalScore = Math.max(0, appleScore - bugPenalty);
        appleGold = totalScore * 3;
        
        // 상금 한도 설정
        appleGold = Math.min(appleGold, 50);
        
        // UI 업데이트
        document.getElementById('appleGold').textContent = appleGold;
        document.getElementById('appleGameResult').classList.remove('hidden');
        document.getElementById('finalAppleGold').textContent = appleGold;
        
        // 골드 증가
        const gold = document.getElementById('gold');
        gold.textContent = parseInt(gold.textContent) + appleGold;
        
        // 알림 표시
        showToast(`${appleGold} 골드가 지급되었습니다!`, 'success');
        
        // 다시하기 버튼 표시
        document.getElementById('applePlayAgainBtn').classList.remove('hidden');
      }
      
      function generateFallingItem() {
        if (!appleGameActive) return;
        
        const gameArea = document.getElementById('appleGameArea');
        const item = document.createElement('div');
        
        // 80% 확률로 사과, 20% 확률로 벌레
        const isApple = Math.random() < 0.8;
        item.textContent = isApple ? '🍎' : '🐛';
        item.className = 'falling-item text-2xl';
        item.dataset.type = isApple ? 'apple' : 'bug';
        
        // 랜덤 위치 (좌우)
        const left = Math.floor(Math.random() * 85) + 5; // 5% ~ 90%
        item.style.left = `${left}%`;
        
        // 랜덤 속도 (아래로 떨어지는 시간)
        const fallSpeed = Math.random() * 1 + 1.5; // 1.5초 ~ 2.5초
        item.style.animationDuration = `${fallSpeed}s`;
        
        gameArea.appendChild(item);
        
        // 아이템이 바닥에 닿았을 때 검사
        item.addEventListener('animationend', () => {
          // 바구니 위치와 아이템 위치 비교
          const itemLeft = parseFloat(item.style.left);
          
          // 충돌 감지 (바구니와 아이템이 겹치는지)
          if (itemLeft >= basketPosition - basketWidth/2 && itemLeft <= basketPosition + basketWidth/2) {
            // 바구니에 들어옴
            if (item.dataset.type === 'apple') {
              // 사과 획득
              appleScore++;
              document.getElementById('appleScore').textContent = appleScore;
              
              // 점수 증가 애니메이션
              const scoreElement = document.getElementById('appleScore');
              scoreElement.classList.add('score-pop');
              setTimeout(() => {
                scoreElement.classList.remove('score-pop');
              }, 500);
            } else {
              // 벌레 감점
              bugPenalty++;
              document.getElementById('bugPenalty').textContent = bugPenalty;
              
              // 감점 애니메이션
              const penaltyElement = document.getElementById('bugPenalty');
              penaltyElement.classList.add('penalty-shake');
              setTimeout(() => {
                penaltyElement.classList.remove('penalty-shake');
              }, 300);
              
              // 바구니 흔들림 애니메이션
              basketElement.classList.add('shake');
              setTimeout(() => {
                basketElement.classList.remove('shake');
              }, 300);
            }
          }
          
          // 아이템 제거
          item.remove();
        });
      }
      
      // 게임 시작 버튼
      document.getElementById('startGameBtn').addEventListener('click', function() {
        // 게임 준비 오버레이 숨기기
        document.getElementById('gameOverlay').classList.add('hidden');
        
        // 게임 활성화
        appleGameActive = true;
        
        // 타이머 시작
        startGameTimer();
        
        // 아이템 생성 시작
        gameInterval = setInterval(generateFallingItem, 800); // 0.8초마다 아이템 생성
      });
      
      // 사과 게임 뒤로가기 버튼
      document.getElementById('appleBackBtn').addEventListener('click', () => {
        // 게임 중이라면 종료
        if (appleGameActive) {
          clearInterval(gameInterval);
        }
        
        switchTab('homeTab');
      });
      
      // 사과 게임 다시하기 버튼
      document.getElementById('applePlayAgainBtn').addEventListener('click', () => {
        // 광고 시청 후 다시하기
        watchAd(() => {
          initAppleGame();
        });
      });
      
      // 사과 게임 탭이 활성화될 때 드래그 이벤트 설정
      document.getElementById('appleGameBtn').addEventListener('click', () => {
        // 기존 코드
        tabContents.forEach(content => {
          content.classList.add('hidden');
          content.classList.remove('active');
        });
        
        document.getElementById('appleGameTab').classList.remove('hidden');
        document.getElementById('appleGameTab').classList.add('active');
        
        // 드래그 이벤트 설정 (추가)
        setupDraggableBasket();
        
        // 사과 게임 초기화
        initAppleGame();
      });
      
      // 나머지 기존 코드 유지
    });
  </script>
</body>
</html>
